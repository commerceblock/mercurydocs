<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mercury Protocol | Mercury Wallet Documentation</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Mercury Wallet Documentation">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.f1075b4d.css" as="style"><link rel="preload" href="/assets/js/app.9034bcfa.js" as="script"><link rel="preload" href="/assets/js/2.ae018d90.js" as="script"><link rel="preload" href="/assets/js/7.60a784a4.js" as="script"><link rel="prefetch" href="/assets/js/10.18f11048.js"><link rel="prefetch" href="/assets/js/11.8d217ddb.js"><link rel="prefetch" href="/assets/js/12.e505a52d.js"><link rel="prefetch" href="/assets/js/13.ed52703c.js"><link rel="prefetch" href="/assets/js/14.67b7c810.js"><link rel="prefetch" href="/assets/js/15.d90a579b.js"><link rel="prefetch" href="/assets/js/16.fc0a8036.js"><link rel="prefetch" href="/assets/js/17.58d9a5e5.js"><link rel="prefetch" href="/assets/js/3.88d448f0.js"><link rel="prefetch" href="/assets/js/4.0ca85bb7.js"><link rel="prefetch" href="/assets/js/5.ca429f71.js"><link rel="prefetch" href="/assets/js/6.aca726e5.js"><link rel="prefetch" href="/assets/js/8.eb9951b3.js"><link rel="prefetch" href="/assets/js/9.93d92fd2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f1075b4d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mercury Wallet Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link router-link-active">
  Docs
</a></div><div class="nav-item"><a href="https://mercurywallet.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mercury Wallet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link router-link-active">
  Docs
</a></div><div class="nav-item"><a href="https://mercurywallet.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mercury Wallet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Docs</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/docs/01protocol.html" aria-current="page" class="active sidebar-link">Mercury Protocol</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/02architecture.html" class="sidebar-link">Mercury Architecture</a></li><li><a href="/docs/03api.html" class="sidebar-link">Mercury API specification</a></li><li><a href="/docs/04lockbox.html" class="sidebar-link">Lockbox specification and API</a></li><li><a href="/docs/05server-build-run.html" class="sidebar-link">Build and run Mercury Server</a></li><li><a href="/docs/06wallet-build-run.html" class="sidebar-link">Build and run Mercury Wallet</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mercury-protocol"><a href="#mercury-protocol" class="header-anchor">#</a> Mercury Protocol</h1> <h3 id="preliminaries"><a href="#preliminaries" class="header-anchor">#</a> Preliminaries</h3> <p>The SE and each owner are required to generate private keys securely and verify ownership of UTXOs (this can be achieved via a wallet interface, but formally should require connection to a fully verifying Bitcoin node). Elliptic curve points (public keys) are depicted as upper case letter, and private keys as lower case letters. Elliptic curve point multiplication (i.e. generation of public keys from private keys) is denoted using the <code>.</code> symbol. The generator point of the elliptic curve standard used (e.g. secp256k1) is denoted as <code>G</code>. All arithmetic operations on secret values (in Zp) are modulo the field the EC standard.</p> <p>Mercury employs the 2-of-2 MPC ECDSA protocol of Lindell as implementated in the ZenGo <code>gotham-city</code> 2-party wallet. The 2-of-2 ECDSA implementation used has two parties (with private keys <code>a</code> and <code>b</code>) where the shared public key is <code>P = ab.G</code> and both parties cooperate to create a signature for <code>P</code> without revealing either <code>a</code> or <code>b</code>.</p> <p>In addition, a public key encryption scheme is required for blinded private key information sent between parties. This should be compatible with the EC keys used for signatures, and ECIES is used. The notation for the use of ECIES operations is as follows: <code>Enc(m,K)</code> denotes the encryption of message <code>m</code> with public key <code>K = k.G</code> and <code>Dec(m,k)</code> denotes the decryption of message <code>m</code> using private key <code>k</code>.</p> <p>All transactions are created and signed using segregated witness, which enables input transaction IDs to be determined before signing and prevents their malleability. The SE specifies and publishes a Mainstay slot ID (<code>slot_id</code>) for the root of the SMT, which all UTXO statechains can be verified against.</p> <h3 id="deposit"><a href="#deposit" class="header-anchor">#</a> Deposit</h3> <p>An owner wants to deposit an amount of BTC into the platform, and they request that the <code>SE</code> cooperate with the initialisation and key generation. To prevent DoS attacks on an anonymous service, the <code>SE</code> may require that the depositor provide proof of ownership (i.e. signatures) for the funds they wish to deposit before proceeding. The following steps are then completed:</p> <ol><li>The depositor (Owner 1) generates a private key: <code>o1</code> (the UTXO private key share).</li> <li>Owner 1 then calculates the corresponding public key of the share <code>O1</code> and sends it to the SE: <code>O1 = o1.G</code></li> <li>The SE then generates a private key: <code>s1</code> (the SE private key share), calculates the corresponding public key and sends it to Owner 1: <code>S1 = s1.G</code></li> <li>Both SE and Owner 1 then multiply the public keys they receive by their own private key shares to obtain the same shared public key <code>P</code> (which corresponds to a shared private key of <code>p = o1*s1</code>): <code>P = o1.(s1.G) = s1.(o1.G)</code></li></ol> <blockquote><p>The above key sharing scheme is the same as that used in the 2P ECDSA protocols [4,5]. The key generation routines of these existing 2P ECDSA implementations can be used in place of the above steps (which include additional verification and proof steps).</p></blockquote> <ol start="5"><li>Owner 1 generates <code>b1</code> (the backup private key) and computes <code>B1 = b1.G</code>.</li> <li>Owner 1 generates <code>c1</code> (the proof private key) and computes <code>C1 = c1.G</code>.</li> <li>Owner 1 creates a funding transaction (<code>Tx0</code>) to pay an amount <code>A</code> to the address corresponding to <code>P</code> (but doesn't sign it) [this transaction may also have an output for a fee <code>F</code> paid to the SE]. This defines the UTXO <code>TxID</code> (the outpoint), which is sent to the SE.</li> <li>Owner 1 creates a <em>backup transaction</em> (<code>Tx1</code>) that pays the <code>P</code> output of <code>Tx0</code> to <code>B1</code>, and sets the <code>nLocktime</code> to the initial future block height <code>h0</code> (where <code>h0 = cheight + hinit</code>, <code>cheight</code> is the current Bitcoin block height and <code>hinit</code> is the specified initial locktime).</li> <li>SE receives <code>Tx1</code> and <code>C1</code> from Owner 1 and verifies the <code>nLocktime</code> field. Owner 1 and the SE then sign <code>Tx1</code> with shared key (<code>P</code>) via 2P ECDSA, which Owner 1 then saves.</li> <li>Owner 1 then signs and broadcasts their deposit transaction <code>Tx0</code>. Once the transaction is confirmed, the deposit is completed.</li> <li>The SE then adds the public key <code>C1</code> to leaf of the SMT at position TxID of <code>Tx0</code>. The root of the SMT is then attested to Bitcoin via the Mainstay protocol in slot <code>slot_id</code>.</li></ol> <p><br><br></p><p align="center"><img src="/assets/img/fig4.12c0b2ac.png" align="middle" width="525" vspace="20"></p><p></p> <p align="center">
  Deposit protocol.
</p> <br><br> <p>This deposit protocol is designed so that no funds are lost if either party becomes uncooperative at any stage. The deposit is only paid to the shared public key once the backup transaction is signed.</p> <h3 id="transfer"><a href="#transfer" class="header-anchor">#</a> Transfer</h3> <p>Owner 1 wishes to transfer the value of the deposit <code>A</code> to a new owner (Owner 2) (as a payment or as part of a complex trade). For this to proceed, the new owner must be aware of the public key that is used to authenticate the SE (<code>SE</code>). The new owner may require the current owner prove their unique ownership by signing a message with their key share (<code>O1</code>) as published on the statechain. The protocol then proceeds as follows:</p> <ol><li>The receiver (Owner 2) generates a backup private key <code>b2</code> and a statechain (proof) private key <code>c2</code> (separate keys are used for privacy). They then compute the corresponding public keys <code>B2 = b2.G</code> and <code>C2 = c2.G</code>.</li> <li><code>B2|C2</code> then represents the Owner 2 'address' and is communicated to Owner 1 (or published) in order for them to 'send' the ownership.</li> <li>Owner 1 then requests that the SE facilitate a transfer to Owner 2 (and that the new owner can be authenticated with <code>C2</code>).</li> <li>SE generates a random key <code>x1</code> and encrypts it with the Owner 1 statechain public key: <code>Enc(x1,C1)</code></li> <li><code>Enc(x1,C1)</code> is sent to Owner 1 who decrypts it with <code>c1</code> to learn <code>x1</code>: <code>Dec(x1,c1)</code></li> <li>Owner 1 then computes <code>o1*x1</code> and encrypts it with the Owner 2 statechain public key (from the address): <code>Enc(o1*x1,C2)</code></li> <li>Owner 1 creates a new <em>backup transaction</em> (<code>Tx2</code>) that pays the <code>P</code> output of <code>Tx0</code> to <code>B2</code>, and sets the <code>nLocktime</code> to the relative locktime <code>h0 - (n-1)*c</code> where <code>c</code> is the confirmation interval and <code>n</code> is the owner number (i.e. 2).</li> <li>The SE receives <code>Tx2</code> and verifies the <code>nLocktime</code> field corresponds to <code>h0 - (n-1)*c</code>. Owner 1 and the SE then sign <code>Tx2</code> with shared key (<code>P</code>) via 2P ECDSA, which Owner 1 then saves.</li></ol> <blockquote><p>The steps 3-8 only require interaction between the SE and owner 1, and can be performed at any time before the involvement of Owner 2 is required.</p></blockquote> <ol start="9"><li>Owner 1 retrieves the UTXO statechain (ownership sequence) for <code>Tx0</code> and signs ownership to <code>C2</code> with private key <code>c1</code>: this is <code>SCTx1</code></li> <li>Owner 1 then sends Owner 2 a message containing four objects:
a. <code>Tx2</code>
b. <code>SCTx1</code>
c. <code>Enc(o1*x1,C2)</code></li></ol> <blockquote><p>At this point the Owner 1 has sent all the information required to complete the transfer to Owner 2 and is no longer involved in the protocol. Owner 2 verifies the correctness and validity of the four objects, and the payment is complete. Owner 1 can then complete the key update with the SE at any time.</p></blockquote> <p>The SE key share update then proceeds as follows:</p> <ol start="11"><li>Owner 2 generates a new output private key share <code>o2</code> and computes <code>O2 = o2.G</code></li> <li>Owner 2 decrypts object d: <code>Dec(o1*x1,c2)</code> and then computes <code>o1*x1*o2_inv</code> where <code>o2_inv</code> is the modular inverse of the private key <code>o2</code>.</li> <li>Owner 2 then encrypts <code>Enc(o1*x1*o2_inv,SE)</code>, signs it with <code>C2</code> and sends it to the SE along with <code>SCTx1</code> and <code>O2</code>.</li> <li>The SE authenticates and decrypts this to learn <code>o1*x1*o2_inv</code>: <code>Dec(o1*x1*o2_inv,se)</code></li> <li>The SE then multiplies this product by <code>x1_inv*s1</code> (where <code>x1_inv</code> the modular inverse of <code>x1</code>) to compute <code>s2 = o1*o2_inv*s1</code>.</li> <li>The SE then verifies that <code>s2.O2 = P</code> and deletes the key share <code>s1</code>. If the SE operations are run in a secure enclave, a remote attestation of this can be sent to Owner 2.</li></ol> <blockquote><p><code>s2</code> and <code>o2</code> are now key the private key shares of <code>P = s2*o2.G</code> which remains unchanged (i.e. <code>s2*o2 = s1*o1</code>), without anyone having learnt the full private key. Provided the SE deletes <code>s1</code>, then there is no way anyone but the current owner (with <code>o2</code>) can spend the output.</p></blockquote> <ol start="17"><li>The SE sends Owner 2 <code>S2 = s2.G</code> who verifies that <code>o2.S2 = P</code></li> <li>The SE then adds the public key <code>C1</code> to the leaf of the SMT at position TxID of <code>Tx0</code>. The root of the SMT is then attested to Bitcoin via the Mainstay protocol in slot <code>slot_id</code>.</li></ol> <p><br><br></p><p align="center"><img src="/assets/img/fig5.bee4fae1.png" align="middle" width="700" vspace="20"></p><p></p> <p align="center">
  Ownership transfer protocol.
</p> <br><br> <blockquote><p>The SE keeps a database of backup transactions for the users, and broadcast them at the appropriate time in case the users are off-line.</p></blockquote> <h3 id="orderly-withdrawal"><a href="#orderly-withdrawal" class="header-anchor">#</a> Orderly Withdrawal</h3> <p>The current owner of a deposit can at any time withdraw from the platform to either gain complete control of the shared key or broadcast a jointly signed transaction. The current owner can request that the SE cooperates in signing a transaction paying the UTXO to certain addresses specified by the owner. The SE may wish to charge a withdrawal fee for providing the service (<code>F</code>), which can be included in this transaction.</p> <p>This would proceed as follows:</p> <ol><li>The current owner (e.g. Owner 2) creates a transaction <code>TxW</code> that spends <code>Tx0</code> to an address <code>W</code>.</li> <li>The owner then requests that the SE cooperate to sign this transaction using the shared public key <code>P</code>.</li> <li>The owner signs the current state concatenated with <code>H(W)</code> with their key <code>C2</code> and sends it to the SE.</li> <li>SE and the owner sign <code>TxW</code>. The SE must confirm that <code>TxW</code> pays to <code>W</code> (otherwise this will create a fraud proof).</li> <li>The fully signed <code>TxW</code> is then broadcast and confirmed.</li> <li>The SE commits the close string to the leaf of the SMT at position TxID of <code>Tx0</code>, to verifiably close the UTXO chain of ownership.</li></ol> <h3 id="backup-withdrawal"><a href="#backup-withdrawal" class="header-anchor">#</a> Backup withdrawal</h3> <p>In the case that the SE disappears or does not cooperate with the current owner, the current owner can reclaim their funds to an address they control by submitting the kick-off transaction, and then after a timelock delay, their backup transaction. In order to get the kick-off transaction to confirm, they will have to simultaneously submit and CPFP transaction spending the <code>OP_TRUE</code> output of <code>TxK</code>.</p> <p>This would proceed as follows:</p> <ol><li>The current owner creates a fee paying transaction <code>TxF</code> has as the <code>OP_TRUE</code> output of <code>TxK</code> as an input, and other signed inputs sufficient to pay the miner fees for both <code>TxF</code> and <code>TxK</code>. The output can be to any address chosen by the owner.</li> <li>The current owner broadcasts both <code>TxK</code> and <code>TxF</code>, which are then confirmed in the Bitcoin blockchain.</li> <li>Once <code>TxK</code> is confirmed, the current owner broadcasts their backup transaction (e.g. <code>Tx2</code>) after the <code>nSequence</code> timelock has expired.</li></ol> <blockquote><p>The owner must ensure they broadcast the backup transaction immediately after the timelock to prevent previous owners from claiming after longer timeouts.</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/" class="prev router-link-active">
        Introduction
      </a></span> <span class="next"><a href="/docs/02architecture.html">
        Mercury Architecture
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9034bcfa.js" defer></script><script src="/assets/js/2.ae018d90.js" defer></script><script src="/assets/js/7.60a784a4.js" defer></script>
  </body>
</html>
