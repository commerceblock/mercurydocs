<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Introduction | Mercury Wallet Documentation</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Mercury Wallet Documentation">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.f1075b4d.css" as="style"><link rel="preload" href="/assets/js/app.0c21ee8f.js" as="script"><link rel="preload" href="/assets/js/2.ae018d90.js" as="script"><link rel="preload" href="/assets/js/3.88d448f0.js" as="script"><link rel="prefetch" href="/assets/js/10.18f11048.js"><link rel="prefetch" href="/assets/js/11.8d217ddb.js"><link rel="prefetch" href="/assets/js/12.e505a52d.js"><link rel="prefetch" href="/assets/js/13.ed52703c.js"><link rel="prefetch" href="/assets/js/14.67b7c810.js"><link rel="prefetch" href="/assets/js/15.d90a579b.js"><link rel="prefetch" href="/assets/js/16.fc0a8036.js"><link rel="prefetch" href="/assets/js/17.58d9a5e5.js"><link rel="prefetch" href="/assets/js/4.0ca85bb7.js"><link rel="prefetch" href="/assets/js/5.ca429f71.js"><link rel="prefetch" href="/assets/js/6.aca726e5.js"><link rel="prefetch" href="/assets/js/7.60a784a4.js"><link rel="prefetch" href="/assets/js/8.eb9951b3.js"><link rel="prefetch" href="/assets/js/9.ff60804c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f1075b4d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mercury Wallet Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Docs
</a></div><div class="nav-item"><a href="https://mercurywallet.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mercury Wallet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Docs
</a></div><div class="nav-item"><a href="https://mercurywallet.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mercury Wallet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Docs</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/" aria-current="page" class="active sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/docs/#statechains" class="sidebar-link">Statechains</a></li></ul></li><li><a href="/docs/01protocol.html" class="sidebar-link">Mercury Protocol</a></li><li><a href="/docs/02architecture.html" class="sidebar-link">Mercury Architecture</a></li><li><a href="/docs/03api.html" class="sidebar-link">Mercury API specification</a></li><li><a href="/docs/04lockbox.html" class="sidebar-link">Lockbox specification and API</a></li><li><a href="/docs/05server-build-run.html" class="sidebar-link">Build and run Mercury Server</a></li><li><a href="/docs/06wallet-build-run.html" class="sidebar-link">Build and run Mercury Wallet</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h1> <p>Mercury is an implementation of a layer-2 statechain protocol that enables off-chain transfer and settlement of Bitcoin outputs that remain under the full custody of the owner at all times, while benefiting from instant and neglible cost transactions. The ability to perform this transfer without requiring the confirmation (mining) of on-chain transactions has advantages in a variety of different applications.</p> <p>This documentation covers the description of the Mercury architecture and protocol, the specification Mercury API and instructions for the deployment and operation of the separate components of the system.</p> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>A <em>unspent transaction outputs</em> (UTXO) is the fundamental object that defines value and ownership in a cryptocurrency such as Bitcoin. A UTXO is identified by a transaction ID (<code>TxID</code>) and output index number (<code>n</code>) and has two properties: 1. A value (in BTC) and 2. Spending conditions (defined in Script). The spending conditions can be arbitrarily complex (within the limits of the consensus rules), but is most commonly defined by a single public key (or public key hash) and can only be spent by transaction signed with the corresponding public key. This is known as a pay-to-public-key-hash output (P2(W)PKH).</p> <p>The simplest function of the Mercury system is to enable the transfer the ownership of individual UTXOs controlled by a single public key <code>P</code> from one party to another without an on-chain (Bitcoin) transaction (or change in the spending condition). The SE facilitates this change of ownership, but has no way to seize, confiscate or freeze the output. To enable this, the private key (<code>s</code>) for <code>P</code> (where <code>P = s.G</code>) is shared between the SE and the owner, such that neither party ever has knowledge of the full private key (which is <code>s = s1*o1</code> where <code>s1</code> is the SE private key share, and <code>o1</code> is the owner key share) and so cooperation of the owner and SE is required to spend the UTXO. However, by sharing the secret key in this way, the SE can change its key share (<code>s1 -&gt; s2</code>) so that it combines with a new owner key share (<code>o2</code>) with the cooperation of the original owner, but without changing the full key (i.e. <code>s1*o1 = s2*o2</code>) all without any party revealing their key shares or learning the full key. The exclusive control of the UTXO then passes to the new owner without an on-chain transaction, and the SE only needs to be trusted to follow the protocol and delete/overwrite the key share corresponding to the previous owner.</p> <p>This key update/transfer mechanism is additionally combined with a system of <em>backup</em> transactions which can be used to claim the value of the UTXO by the current owner in the case the SE does not cooperate or has disappeared. The backup transaction is cooperatively signed by the current owner and the SE at the point of transfer, paying to an address controlled by the new owner. To prevent a previous owner (i.e. not the current owner) from broadcasting their backup transaction and stealing the deposit, the <code>nLocktime</code> value of the transaction is set to a future specified block height. Each time the ownership of the UTXO is transferred, the <code>nLocktime</code> is decremented by a specified value, therefore enabling the current owner to claim the deposit before any of the previous owners.</p> <p><br><br></p><p align="center"><img src="/assets/img/fig1.edc83907.png" align="middle" width="350" vspace="20"></p><p></p> <p align="center">
  Schematic of confirmed funding transaction, and off-chain signed backup transactions with decrementing nLocktime for a sequence of 4 owners.
</p> <br><br> <p>The decrementing timelock backup mechanism limits the number of transfers that can be made within a reasonable lock-out time, and will be specified and enforced by the SE. In order to ensure that the valid backup transaction is broadcast to the Bitcoin network at the correct time, and prevent expired owners from attempting to steal funds, the SE operates multiple <em>watch</em> servers that monitor the block height and broadcast user backup transactions when required. If the SE is shut down then the user is responsible for submitting backup transactions to the Bitcoin network at the correct time, and applications are available to do this automatically.</p> <p>The life-cycle of a P2PKH deposit into the statechain, transfer and withdrawal is summarised as follows:</p> <ol><li>The depositor (Owner 1) initiates a UTXO statechain with the SE by paying BTC to a P2PKH address where Owner 1 and the SE share the private key required to spend the UTXO. Additionally, the SE and the depositor can cooperate to sign a backup transaction spending the UTXO to a relative timelocked transaction spending to an address controlled by Owner 1 which can be confirmed after the <code>nLocktime</code> block height in case the SE stops cooperating.</li> <li>Owner 1 can verifiably transfer ownership of the UTXO to a new party (Owner 2) via a key update procedure that overwrites the private key share of SE that invalidates the Owner 1 private key and <em>activates</em> the Owner 2 private key share. Additionally, the transfer can incorporate the cooperative signing of a new backup transaction paying to an address controlled by Owner 2 which can be confirmed after an <code>nLocktime</code> block height, which is shortened (by an accepted confirmation interval) from the previous owners backup transaction <code>nLocktime</code>.</li> <li>This transfer can be repeated multiple times to new owners as required (up until the most recent recovery <code>nLocktime</code> reaches a lower limit determined by the current Bitcoin block height).</li> <li>At any time the most recent owner and SE can cooperate to sign a transaction spending the UTXO to an address of the most recent owner's choice (i.e. withdrawal).</li></ol> <p>Double-spending of the UTXO (by a corrupt SE) is prevented by a proof-of-uniqueness from the Mainstay protocol. Each unique transfer of the UTXO between owners is recorded on the SE statechain, with each transfer requiring a signature from the current owner. Spending of the UTXO by anyone except the current owner can be unambiguously proven as fraudulent by the current owner.</p> <h2 id="statechains"><a href="#statechains" class="header-anchor">#</a> Statechains</h2> <p>The essential function of the Mercury system is that it enables 'ownership' (and control) of a UTXO to be transferred between two parties (who don't need to trust each other) via the SE without an on-chain transaction. The SE only needs to be trusted to operate the protocol (and crucially not store any information about previous key shares) and then the transfer of ownership is completely secure, even if the SE was to later get compromised or hacked. At any time the SE can prove that they have the key share for the current owner (and only to the current owner). Additional trust would be required in the SE that they are not double-spending the output, however they would need to collude with a current owner in order to attempt to do this. However a new owner (i.e. the buyer of the UTXO) requires a guarantee that this hasn't happened (i.e. that the current owner and SE have conspired to pass ownership to two or more buyers). To guarantee this, the new owner requires a proof that their ownership is <em>unique</em>: this is achieved via UTXO <em>statechains</em> - immutable and unique sequences of verifiable ownership transfer. The current owner is required to sign a <em>statechain transaction</em> (<code>SCTx</code>) with an owner key to transfer ownership to a new owner (i.e. a new owner key). This means that any theft of the UTXO by the collusion of a corrupt SE and old owner can be independently and conclusively proven.</p> <p>The <em>ownership proof</em> then consists of a unique sequence of ownership keys (with signed transfers) for the full history of each UTXO. This full history is published by the SE, using the Mainstay protocol to ensure this sequence is both unique and immutable. This utilises Bitcoin's global state (resulting in a verifiable <em>proof of publication</em> for each ownership change).</p> <h3 id="sparse-merkle-tree"><a href="#sparse-merkle-tree" class="header-anchor">#</a> Sparse Merkle Tree</h3> <p>A specific SE will operate the proof of publication for all UTXO ownership sequences under its management via a single Mainstay slot (for details refer to the Mainstay <a href="https://commerceblock.readthedocs.io/en/latest/mainstay-con/index.html" target="_blank" rel="noopener noreferrer">documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>). The SE will commit the root of a <a href="https://eprint.iacr.org/2016/683.pdf" target="_blank" rel="noopener noreferrer"><em>sparse Merkle tree</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (SMT) into the specified slot every time it is updated (which then in turn is attested to the Bitcoin staychain every block/hour). The SMT has a leaf for each unique UTXO TxID (256 bit number) managed by the SE, and the current UTXO statechain is committed to this leaf at each update. The use of the SMT enables proof that each leaf commitment is unique to the UTXO TxID.</p> <p><br><br></p><p align="center"><img src="/assets/img/proof1.3da35c27.png" align="middle" width="440" vspace="20"></p><p></p> <p align="center">
  Illustration of sequences of UTXO ownership (statechains) committed to the sparse Merkle tree (SMT), the root of which is in turn committed to a defined Mainstay slot (slot_id), which is in turn committed to the staychain of transactions on the Bitcoin blockchain.
</p> <br><br> <h3 id="ownership-transfer"><a href="#ownership-transfer" class="header-anchor">#</a> Ownership transfer</h3> <p>The UTXO ownership sequence consists of a chain of <em>statechain transactions</em> (<code>SCTx</code>) transferring ownership. This chain starts with the single <em>proof</em> public key of the depositor, and each time the ownership of the UTXO is passed from one owner to the next, the current owner must sign the statechain concatenated with the new owner proof public key. Specifically, when a user deposits into a new UTXO with the SE, they provide a proof public key <code>C1</code> (to which only the depositor knows the private key <code>c1</code>). This initial state (<code>s_1 = H(C1)</code> where <code>H(...)</code> denotes the SHA256 hash function) is committed to the SE SMT at the position of the UTXO TxID.</p> <p>When the depositor (<code>C1</code>) then transfers ownership to <code>C2</code> they provide a signature <code>sig_C1</code> over <code>s_1|C2</code> and the new state:</p> <p><code>s_2 = H(s_1|C2|sig_C1[s_1|C2])</code></p> <p>which is then committed to the SMT at the position of the UTXO TxID. Then when the owner <code>C2</code> transfers ownership to <code>C3</code> they provide a signature <code>sig_C2</code> over <code>s_2|C3</code>. The new state then becomes:</p> <p><code>s_3 = H(s_2|C3|sig_C2[s_2|C3])</code></p> <p>and so on for each transfer of ownership from <code>old_key</code> to <code>new_key</code>:</p> <p><code>new_state = H(old_state|new_key|sig_old_key[old_state|new_key])</code></p> <p>If no change of ownership occurs between Mainstay attestations, the state does not change (and the latest slot attestation is the proof of publication). If the ownership changes more frequently than the slot attestation, then the ownership state is updated for each transfer and the current state is attested at the next interval.</p> <p><br><br></p><p align="center"><img src="/assets/img/proof2.cde89ca4.png" align="middle" width="500" vspace="20"></p><p></p> <p align="center">
  Merkle path proofs of UTXO state publication. The committed state for a specified UTXO TxID is updated as the ownership is transferred between public keys.
</p> <br><br> <h3 id="fraud-proof"><a href="#fraud-proof" class="header-anchor">#</a> Fraud Proof</h3> <p>The statechain (and its proof of publication in the Bitcoin staychain) for a specific UTXO can be used by the current owner as proof of ownership and as a fraud proof if the UTXO is spent without their permission (i.e. by a corrupt or colluding SE keeping old key shares). This acts as a powerful incentive to keep the SE honest and preventing them from committing a large scale fraud. In order to spend the UTXO, the current owner must sign a <code>SCTx</code> transaction with their proof public key (<code>C</code>) to the address the Bitcoin UTXO is paid to - if this address is different, this is proof that the SE is corrupt.</p> <p>The proof-of-publication (via Mainstay) acts as a proof of unique ownership of the UTXO by the owner, however this has a latency that is limited by the Mainstay attestation period (i.e. the Bitcoin block confirmation time). Proof of ownership cannot be obtained faster than this, however a proof of fraud can be. The state can be committed to an unconfirmed Mainstay transaction instantly (and updated via the replace-by-fee mechanism) which must be signed by the Mainstay operator.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/docs/01protocol.html">
        Mercury Protocol
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0c21ee8f.js" defer></script><script src="/assets/js/2.ae018d90.js" defer></script><script src="/assets/js/3.88d448f0.js" defer></script>
  </body>
</html>
